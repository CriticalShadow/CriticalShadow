<div id="map"></div>
<article id="narrative">
  <div class="sections prose">
    <section id="cover" class="cover active">
      <h1>{{title}}</h1>
      <small class="scroll quiet">Scroll &#x25BE;</small>
    </section>
    <section ng-repeat="entry in locations" id="{{entry.name}}">
      <h3>{{entry.name}}</h3>
      <p>{{entry.desc}}</p>
    </section>
    <section id="dummy"></section>
  </div>
</article>
<div>
<script>
var narrative = document.getElementById('narrative');
var sections = narrative.getElementsByTagName('section');
var currentId = '';

var setId = function (newId) {
  if (newId === currentId) {
    return;
  }

  placesLayer.eachLayer(function (layer) {
    if (layer.feature.properties.id === newId) {
      map.setView(layer.getLatLng(), layer.feature.properties.zoom || 16);
      layer.setIcon(L.mapbox.marker.icon({
        'marker-color': '#FF2249',
        'marker-size': 'large',
        'marker-symbol': 'college'
      }));
    } else {
      layer.setIcon(L.mapbox.marker.icon({
        'marker-color': '#404040',
        'marker-size': 'large',
        'marker-symbol': 'college'
      }));
    }
  });

  for (var i = 0; i < sections.length; i++) {
    if (sections[i].id === newId) {
      sections[i].className = 'active'
    } else {
      sections[i].className = '';
    }
  }
  currentId = newId;
};

setId('cover');

var onScroll = _.debounce(function (e) {
  var narrativeHeight = narrative.offsetHeight;
  var newId = currentId;
  for (var i = sections.length - 1; i >= 0; i--) {
    var rect = sections[i].getBoundingClientRect();
    if (rect.top >= 0 && rect.top <= narrativeHeight) {
      newId = sections[i].id;
    }
  };
  setId(newId);
}, 50);

narrative.onscroll = onScroll;
</script>