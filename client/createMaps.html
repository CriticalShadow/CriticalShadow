<!DOCTYPE html>
<html>
  <head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" charset="utf-8">  
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  
  <link rel="stylesheet" type="text/css" href="./css/bootstrap-3.3.2-dist/css/bootstrap.css">
  <link href='css/styles.css' rel='stylesheet' />
  <script>
    $(document).ready(function(){

    var global_lat, global_lon;
    var geocoder = new google.maps.Geocoder();
    var infowindow = new google.maps.InfoWindow({
      maxWidth: 100
    });
    var map;
    var pointCounter = 0;

    // GLOBAL DATA OBJECT TO BE SENT TO SERVER
    var data = {
      mapName: null,
      locations: [] // array of objects contains points. 
    };
    
    // Note: need to run a server for geoFindMe()
    // python -m SimpleHTTPServer
    function geoFindMe() {
      if (!navigator.geolocation){
        alert("Geolocation is not supported by your browse");
        return;
      }
      function success(position) {
        var latitude  = position.coords.latitude;
        var longitude = position.coords.longitude;
        //SET GLOBAL
        global_lat = latitude;
        global_lon = longitude;

        console.log('current location: '+global_lat+','+global_lon);
        initialize();
      };
      function error() {
        alert("Can't find your location. Please adjust settings");
      };

      navigator.geolocation.getCurrentPosition(success, error);
    }// geoFindMe()
     

     
    function initialize() {
      var map_canvas = document.getElementById('map-canvas');
      var myLatlng = new google.maps.LatLng(global_lat, global_lon);
      var map_options = {
        center: myLatlng,
        zoom: 13, 
        mapTypeId: google.maps.MapTypeId.ROADMAP, 
        panControl: true,
          panControlOptions: {
          position: google.maps.ControlPosition.RIGHT_TOP
        },
        zoomControl: true,
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.LARGE,
          position: google.maps.ControlPosition.RIGHT_TOP
        }
      }
      map = new google.maps.Map(map_canvas, map_options)
      
      //************** CLICK LISTENER ****************//
      google.maps.event.addListener(map, 'click', function (event) {
          var latitude = event.latLng.lat();
          var longitude = event.latLng.lng();
          codeLatLng(latitude, longitude, function(address_data){
            var nameParse = function(address){
              console.log(address);
              var temp = address.split(',');
              return temp[0];
            }

            // TODO: POINT & CLICK
            $('.div_container').append(
            '<div class="onePoint"><input class="form-control inputSize in_name' + pointCounter +'" value=\"'+ nameParse(address_data) +'\"+></input>'+
            '<textarea placeholder="Enter location description here" class="form-control inputSize in_text' + pointCounter +'"></textarea><br><input type=hidden class="pointAddr' + pointCounter +'"value=\"'+address_data+'\"+></input><input type=hidden class="pointLat' + pointCounter +'"value='+latitude+'></input><input type=hidden class="pointLng' + pointCounter++ +'"value='+longitude+'></input></div>'
            );//note: pointCounter++ is so the next one with have +1 index.
          });
      });

    //************** SEARCH BAR FUNCTIONALITY ****************//
      var input = (document.getElementById('pac-input'));
      var searchBox = new google.maps.places.SearchBox(
        /** @type {HTMLInputElement} */(input));

      // [START region_getplaces]
      // Listen for the event fired when the user selects an item from the
      // pick list. Retrieve the matching places for that item.
      google.maps.event.addListener(searchBox, 'places_changed', function() {
        var places = searchBox.getPlaces();
        //grab input value inside function once address is submit.
        console.log("PLACES: "+ input.value);
        if (places.length == 0) {
          return;
        }

        for (var i = 0, place; place = places[i]; i++) {
          // Create a marker for each place.
          var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location
          });
          infowindow.setContent(input.value);
          infowindow.open(map, marker);

          var nameParse = function(address){
            var temp = address.split(',');
            return temp[0];
          }

        $('.div_container').append(
          '<div class="onePoint"><input class="form-control inputSize in_name' + pointCounter +'" value=\"'+ nameParse(input.value)+'\"+></input>'+
          '<textarea placeholder="Enter location description here" class="inputSize form-control in_text' + pointCounter +'"></textarea><br><input type=hidden class="pointAddr' + pointCounter +'"value=\"'+input.value+'\"+></input><input type=hidden class="pointLat' + pointCounter +'"value='+place.geometry.location.lat()+'></input><input type=hidden class="pointLng' + pointCounter++ +'"value='+place.geometry.location.lng()+'></input></div>'
          );//note: pointCounter++ is so the next one with have +1 index.

          $('#pac-input').val(''); 
          input.value = '';
        //bounds.extend(place.geometry.location);
        }// for
      });
      // google.maps.event.addListener(map, 'bounds_changed', function() {
      //   var bounds = map.getBounds();
      //   searchBox.setBounds(bounds);
      // });
    }//initialize()

    // google geoCoder. Returns a physical address from latt and lng. 
    // Quotas: 5 per second and 2500 per day. 
    function codeLatLng(latt, Lon, cb) {
      var lat = latt;
      var lng = Lon;
      var latlng = new google.maps.LatLng(lat, lng);

      geocoder.geocode({'latLng': latlng}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          if (results[1]) {
            marker = new google.maps.Marker({
                position: latlng,
                map: map
            });
            infowindow.setContent(results[1].formatted_address);
            infowindow.open(map, marker);
            cb(results[1].formatted_address);
          } else {
            alert('No results found');
          }
        } else {
          alert('Geocoder failed due to: ' + status);
        }
      });
    }//codeLatLng()


    google.maps.event.addDomListener(window, 'load', geoFindMe);

    //map title validity checker. 
    function submitform() {
      var f = document.getElementsByTagName('form')[0];
      if(f.checkValidity()) {
        return true;
      } else {
        return false;

      }
    }
    //*****************SUBMIT BUTTON*********************//
    $('.pushToServer').click(function(){
      if(submitform()){
      var points_length = $('.onePoint').length;
      for( var i = 0; i < points_length; i++ ){
        var pointObj = {};
        pointObj['name'] = $('.in_name'+i).val();
        pointObj['lat'] = $('.pointLat'+i).val();
        pointObj['lng'] = $('.pointLng'+i).val();
        pointObj['address'] = $('.pointAddr'+i).val();
        pointObj['desc'] = $('.in_text'+i).val();

        data.locations.push(pointObj);
      }
      data.mapName = $('#mapTit').val();
      console.log(data);

      $.ajax({
          type: "POST",
          url: '/createMaps',
          data: data,
          success: function (res){
            console.log('Successful POST!');
            console.log(res);
          },
          error: function(){
            console.log('POST Error');
          }
      });
    } else {
      alert('Please Enter a Map Title');
    }
    });
    });// DOM ready
  </script>
  </head>
  <body>
    <div class='containerMap'>
          <div id="map-canvas"></div> 
        <div class="col-md-4 sidebar">
          <form>
            <h3 style="color:white"><center>Create Your Map!</center></h3>
            <input id="mapTit" class='inputWidth form-control' type='text' placeholder='Enter Map Title' required>
            <input id="pac-input" class="controls" type="text" placeholder="Enter Location">
          <hr>
          <div class='div_container'></div>
            <button type='button' class="btnSize btn btn-success pushToServer">Submit</button>
            <button type='reset' class="btnSize btn btn-danger" value="Reset">Reset</button>
          </form>
        </div>
    </div>
  </body>
</html>
